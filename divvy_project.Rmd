---
title: "divvy_project"
author: "Imogen Meers, Sarah Deussing, Sarah Cernugel"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
divvy <- read.csv("divvy data.csv")
head(divvy)
```
```{r}
library(dplyr)
library(readr)
library(purrr)
library(stringr)
library(tibble)
library(magick)
library(aws.s3)
```

```{r Reading from S3 bucket}
bucket_exists("s3://divvy-tripdata/") #check bucket exists

data <- get_bucket_df(
  bucket = "s3://divvy-tripdata/", 
  region = "us-east-1", 
  max = 20000
) %>% 
  as_tibble() #find contents of bucket

keys <- data[1:54,]$Key #get zip files that we want

save_object(object = keys[[1]], bucket = "divvy-tripdata",region = "us-east-1", file = temp) 
s3read_using(FUN = save_object, object = keys[[1]], bucket = "divvy-tripdata", region = "us-east-1", file = temp)

download_and_unzip <- function(key) { 
  temp <- tempfile() 
  save_object(object = key, bucket = "divvy-tripdata",region = "us-east-1", file = temp) 
  unzipped_files <- unzip(temp, exdir = tempdir()) 
  print(paste("File ", key, " unzipped"))
  return(read.csv(unzipped_files[1]))
} # Function to unzip each file into a temp file 

# Apply function to each key in your data frame 
result_list <- lapply(keys, download_and_unzip)

# Combine into a single data frame 
result_df <- do.call(rbind, result_list)


# save_object(
#   object = "202004-divvy-tripdata.zip",
#   bucket = "s3://divvy-tripdata/", 
#   region = "us-east-1",
#   file = "202004-divvy-tripdata.zip"
# )

#Should save as a RData file to prevent having to run this every time
```


```{r Reading from S3 bucket}
load("InitRData.RDataTmp")
```

```{r}
summary(result_df)
```
```{r}
library(dplyr)
head(result_df)
unique(result_df$rideable_type)
summary(as.factor(result_df$rideable_type))

scooter <- result_df %>% filter(rideable_type == "electric_scooter")
summary(scooter)
docked_bike <- result_df %>% filter(rideable_type == "docked_bike") 
summary(classic_bike)
```

```{r}
library(ggmap)
register_stadiamaps("9e07144d-cdab-48f9-a35d-298e1bbece2e")

# Define the bounding box for Chicago
bbox <- c(left = -87.9400, bottom = 41.6445, right = -87.5240, top = 42.0230)

# Get the map
chi_map <- get_stadiamap(bbox = bbox, zoom = 12, maptype = "stamen_toner")


# Plot the map
scooter_map <- ggmap(chi_map) +
  geom_point(data = scooter, aes(x = start_lng, y = start_lat, alpha = 0.05, color = "red")) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
  ) + 
  labs(
    title = "Scooter Map"
  )+
  guides(alpha = "none")

scooter_map
```

```{r}
# Plot the map
bike_map <- ggmap(chi_map) +
  geom_point(data = docked_bike, aes(x = start_lng, y = start_lat, alpha = 0.05, color = "blue")) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
  ) + 
  labs(
    title = "Bike Map"
  )+
  guides(alpha = "none")

bike_map
```


