---
title: "An Analysis of Chicago's Divvy Transport"
author: "Imogen Meers, Sarah Deussing, Sarah Cernugel"
date: "`r Sys.Date()`"
output: html_document
---

## Introduction

#### Questions
We want to look at the trends of Divvy bike and scooter data in Chicago, Illinois and how Divvy use changes with events that occur throughout the year. Doing so will allow us to recommend business changes to improve Divvy's revenue in Chicago. 

#### Data Cleaning & Preprocessing
Our data comes from many different sources. We will use Divvy data from 2020-2024, as well as professional sports schedules from the same years. These sports schedules will come from R packages, and our important columns will be game date and game start time. To merge all sports schedule data sets, we will have to standardize the format of these dates and times.

We will then merge this data with the Divvy data to look at changes to Divvy use on these pre-identified games and times. In terms of creating new values, we can look at the change/difference in Divvy use from days without sporting events to days with games. We will also look for patterns in vehicle type and membership, which will be useful to provide recommendations for where to adding new docks or make more bikes/scooters available depending on the event and if there are patterns between casual users vs members.

## Initial Data Analysis
Data Cleaning, Exploratory Visualizations

#### Divvy Data
```{r}
divvy <- read.csv("divvy data.csv")
head(divvy)
```

```{r}
library(dplyr)
library(readr)
library(purrr)
library(stringr)
library(tibble)
library(magick)
library(aws.s3)
library(tidyr)
```

```{r Reading from S3 bucket, eval = FALSE}
bucket_exists("s3://divvy-tripdata/") #check bucket exists

data <- get_bucket_df(
  bucket = "s3://divvy-tripdata/", 
  region = "us-east-1", 
  max = 20000
) %>% 
  as_tibble() #find contents of bucket

keys <- data[1:54,]$Key #get zip files that we want

save_object(object = keys[[1]], bucket = "divvy-tripdata",region = "us-east-1", file = temp) 
s3read_using(FUN = save_object, object = keys[[1]], bucket = "divvy-tripdata", region = "us-east-1", file = temp)

download_and_unzip <- function(key) { 
  temp <- tempfile() 
  save_object(object = key, bucket = "divvy-tripdata",region = "us-east-1", file = temp) 
  unzipped_files <- unzip(temp, exdir = tempdir()) 
  print(paste("File ", key, " unzipped"))
  return(read.csv(unzipped_files[1]))
} # Function to unzip each file into a temp file 

# Apply function to each key in your data frame 
result_list <- lapply(keys, download_and_unzip)

# Combine into a single data frame 
result_df <- do.call(rbind, result_list)


# save_object(
#   object = "202004-divvy-tripdata.zip",
#   bucket = "s3://divvy-tripdata/", 
#   region = "us-east-1",
#   file = "202004-divvy-tripdata.zip"
# )

#Should save as a RData file to prevent having to run this every time
```

```{r Reading from S3 bucket}
load("InitRData.RDataTmp")
```

```{r}
summary(result_df)
```
```{r}
library(dplyr)
head(result_df)
unique(result_df$rideable_type)
summary(as.factor(result_df$rideable_type))

scooter <- result_df %>% filter(rideable_type == "electric_scooter")
scooter_sample <- sample_n(scooter, 5000)

summary(scooter)
classic_bike <- result_df %>% filter(rideable_type == "classic_bike")
classic_sample <- sample_n(classic_bike, 5000)

docked_bike <- result_df %>% filter(rideable_type == "docked_bike")
docked_sample <- sample_n(docked_bike, 5000)

electric_bike <- result_df %>% filter(rideable_type == "electric_bike")
electric_sample <- sample_n(electric_bike, 5000)

member_sample <- result_df %>% filter(member_casual == "member") %>% sample_n(5000)
casual_sample <- result_df %>% filter(member_casual == "casual") %>% sample_n(5000)

unique(result_df$member_casual)
```

```{r}
library(ggmap)
register_stadiamaps("9e07144d-cdab-48f9-a35d-298e1bbece2e")

# Define the bounding box for Chicago
bbox <- c(left = -87.9400, bottom = 41.6445, right = -87.5240, top = 42.0230)

# Get the map
chi_map <- get_stadiamap(bbox = bbox, zoom = 12, maptype = "stamen_toner")


# Plot the map
scooter_map <- ggmap(chi_map) +
  geom_point(data = scooter_sample, aes(x = start_lng, y = start_lat, alpha = 0.05), color = "red") +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
  ) + 
  labs(
    title = "Scooter Map"
  )+
  guides(alpha = "none")

scooter_map
```

```{r}
# Plot the map
classic_map <- ggmap(chi_map) +
  geom_point(data = classic_sample, aes(x = start_lng, y = start_lat, alpha = 0.05), color = "blue") +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
  ) + 
  labs(
    title = "Classic Bike Map"
  )+
  guides(alpha = "none")

docked_map <- ggmap(chi_map) +
  geom_point(data = docked_sample, aes(x = start_lng, y = start_lat, alpha = 0.05), color = "green") +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
  ) + 
  labs(
    title = "Docked Bike Map"
  )+
  guides(alpha = "none")


electric_map <- ggmap(chi_map) +
  geom_point(data = electric_sample, aes(x = start_lng, y = start_lat, alpha = 0.05), color = "orange") +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
  ) + 
  labs(
    title = "Electric Bike Map"
  )+
  guides(alpha = "none")

classic_map
electric_map
docked_map


library(gridExtra)
grid.arrange(scooter_map, classic_map, electric_map, docked_map, nrow = 2, ncol = 2)
```
```{r}
# Plot the map
member_map <- ggmap(chi_map) +
  geom_point(data = member_sample, aes(x = start_lng, y = start_lat, alpha = 0.05), color = "blue") +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
  ) + 
  labs(
    title = "Member Map"
  )+
  guides(alpha = "none")

casual_map <- ggmap(chi_map) +
  geom_point(data = casual_sample, aes(x = start_lng, y = start_lat, alpha = 0.05), color = "green") +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
  ) + 
  labs(
    title = "Casual Map"
  )+
  guides(alpha = "none")

library(gridExtra)
grid.arrange(casual_map, member_map, ncol=2)
```

<<<<<<< Updated upstream
#### Sports Schedules
NBA Schedule

## NBA Schedule
```{r}
#install.packages("hoopR")
library(hoopR)
nba_19 <- nba_schedule(league_id = "00", season = 2019)
nba_20 <- nba_schedule(league_id = "00", season = 2020)
nba_21 <- nba_schedule(league_id = "00", season = 2021)
nba_22 <- nba_schedule(league_id = "00", season = 2022)
nba_23 <- nba_schedule(league_id = "00", season = 2023)
nba_24 <- nba_schedule(league_id = "00", season = 2024)

#nba <- full_join(nba_20, full_join(nba_21, full_join(nba_22, full_join(nba_23, nba_24))))
nba <- rbind(nba_19,nba_20, nba_21, nba_22, nba_23, nba_24)

nba <- filter(nba, arena_name == "United Center", game_status == "3")
nba %>% arrange(desc(game_date))
summary(nba)
nba_dates <- unique(nba$game_date)
```

MLB Schedule
```{r}
#install.packages("baseballr")
library(baseballr)

mlb_19 <- mlb_schedule(season = 2019, level_ids = "1")
mlb_20 <- mlb_schedule(season = 2020, level_ids = "1")
mlb_21 <- mlb_schedule(season = 2021, level_ids = "1")
mlb_22 <- mlb_schedule(season = 2022, level_ids = "1")
mlb_23 <- mlb_schedule(season = 2023, level_ids = "1")
mlb_24 <- mlb_schedule(season = 2024, level_ids = "1")

mlb <- rbind(mlb_19, mlb_20, mlb_21, mlb_22, mlb_23, mlb_24)
#mlb <- full_join(mlb_20, full_join(mlb_21, full_join(mlb_22, full_join(mlb_23, mlb_24))))
mlb <- mlb %>% filter(venue_name == "Wrigley Field" | venue_name == "Guaranteed Rate Field") %>% mutate(date = as.Date(date))
summary(mlb)
mlb_dates <-  unique(mlb$date)
```



## NFL Schedule
```{r}
#install.packages("nflfastR")
library(nflfastR)
nfl <- nflreadr::load_schedules()
nfl$gameday <- as.Date(nfl$gameday)
nfl <- nfl %>%
  filter(gameday >= as.Date('2020-01-01') & gameday <= as.Date('2024-12-31') & stadium == "Soldier Field")
summary(nfl)
nfl_dates <-  unique(nfl$gameday) 
```

NHL Schedule
```{r}
#install.packages('fastRhockey')
library(fastRhockey)
nhl19 <- load_nhl_schedule(2019)
nhl20 <- load_nhl_schedule(2020)
nhl21 <- load_nhl_schedule(2021)
nhl22 <- load_nhl_schedule(2022)
nhl23 <- load_nhl_schedule(2023)
nhl24 <- load_nhl_schedule(2024)

nhl <- rbind(nhl19, nhl20, nhl21, nhl22, nhl23, nhl24, fill=TRUE)
nhl <- nhl %>% filter(venue_name == "United Center") %>% mutate(game_date = as.Date(game_date))
summary(nhl)
nhl_dates <-  unique(nhl$game_date)
```

Combine into all Dates
```{r}
dates <- seq.Date(from = as.Date("2020-01-01"), to = as.Date("2024-12-31"), by = "day")
dates <- data.frame(date = dates)

mlb_dates <- as.Date(mlb_dates)
nba_dates <- as.Date(nba_dates)
nfl_dates <- as.Date(nfl_dates)
nhl_dates <- as.Date(nhl_dates)
dates <- dates %>%
  mutate(mlb = if_else(date %in% mlb_dates, 1, 0),
         nba = if_else(date %in% nba_dates, 1, 0),
         nfl = if_else(date %in% nfl_dates, 1, 0),
         nhl = if_else(date %in% nhl_dates, 1, 0))
```

Event "Calendar" By Sport
```{r}
library(ggplot2)
library(tidyr)

dates_long <- dates %>%
  pivot_longer(cols = c(mlb, nhl, nba, nfl), 
               names_to = "sport", 
               values_to = "game", 
               names_prefix = "_events") %>%
  filter(game == 1)

dates_long <- dates_long %>%
  mutate(year = as.integer(format(date, "%Y")))

ggplot(dates_long, aes(x = date, y = sport, color = sport)) +
  geom_point(size = 3) +
  scale_y_discrete(limits = c("mlb", "nhl", "nba", "nfl")) +
  labs(x = "Date", y = "Sport", title = "Game Occurences by Sport") +
  theme_minimal() +
  theme(legend.position = "none") +
  facet_wrap(~ year, scales = "free_x", ncol = 1)
```

Total Events Per Day
```{r}
events_per_day <- dates_long %>%
  group_by(date) %>%
  summarise(events = n()) %>%
  mutate(year = as.integer(format(date, "%Y")))

ggplot(events_per_day, aes(x = date, y = events)) +
  geom_line(color = "blue", size = 1) +
  labs(x = "Date", y = "Number of Events", title = "Sports Events Per Day") +
  theme_minimal() +
  facet_wrap(~ year, scales = "free_x", ncol = 1) + 
  theme(legend.position = "none")
```

```{r Filter to game days}
filtered_df <- result_df %>% mutate(start_date = as.Date(started_at)) %>% filter(start_date %in% dates_long$date)
```

```{r}
load("FilteredAndTeams.RData")
summary(filtered_df)
filtered_df <- filtered_df %>% na.omit()
```

